<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试修复 - 历史记录功能</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #45a049;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <h1>🔧 历史记录功能修复测试</h1>
  
  <div class="test-section">
    <h2>测试项目</h2>
    <p>这个页面用于测试鼠标轨迹和反应测试游戏的历史记录功能是否已经修复。</p>
    
    <h3>测试步骤：</h3>
    <ol>
      <li>点击下面的"测试历史管理器"按钮，检查基础功能</li>
      <li>点击"测试鼠标轨迹历史"按钮，检查鼠标轨迹游戏的历史记录</li>
      <li>点击"测试反应测试历史"按钮，检查反应测试游戏的历史记录</li>
      <li>如果所有测试都通过，说明修复成功</li>
    </ol>
  </div>

  <div class="test-section">
    <h2>功能测试</h2>
    <button class="test-button" onclick="testHistoryManager()">测试历史管理器</button>
    <button class="test-button" onclick="testMouseHistory()">测试鼠标轨迹历史</button>
    <button class="test-button" onclick="testReactionHistory()">测试反应测试历史</button>
    <button class="test-button" onclick="clearTestData()">清理测试数据</button>
    <button class="test-button" onclick="showStorageInfo()">查看存储信息</button>
    <button class="test-button" onclick="resetAllGames()" style="background: #dc3545;">全局重置所有游戏</button>
    <button class="test-button" onclick="testHistoryModal()" style="background: #17a2b8;">测试历史弹窗</button>
  </div>

  <div id="test-results"></div>

  <script src="game-history.js"></script>
  <script src="history-modal.js"></script>
  
  <script>
    function showResult(message, type = 'info') {
      const resultsDiv = document.getElementById('test-results');
      const resultDiv = document.createElement('div');
      resultDiv.className = `status ${type}`;
      resultDiv.innerHTML = message;
      resultsDiv.appendChild(resultDiv);
      
      // 自动滚动到底部
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }

    function testHistoryManager() {
      try {
        if (!window.gameHistoryManager) {
          showResult('❌ 历史管理器未加载', 'error');
          return;
        }

        // 测试基本功能
        const testScore = {
          score: 85,
          moves: 10,
          timeSpent: 5000
        };

        // 记录测试成绩
        const record = window.gameHistoryManager.recordGameScore('mouse', 'default', testScore);
        showResult('✅ 历史管理器基础功能正常', 'success');

        // 测试获取历史记录
        const history = window.gameHistoryManager.getGameHistory('mouse', 'default');
        showResult(`✅ 成功获取历史记录，当前记录数: ${history.length}`, 'success');

        // 测试获取统计信息
        const stats = window.gameHistoryManager.getGameStats('mouse', 'default');
        showResult(`✅ 成功获取统计信息，最佳成绩: ${stats.bestScore}`, 'success');

      } catch (error) {
        showResult(`❌ 历史管理器测试失败: ${error.message}`, 'error');
      }
    }

    function testMouseHistory() {
      try {
        if (!window.gameHistoryManager) {
          showResult('❌ 历史管理器未加载', 'error');
          return;
        }

        // 添加一些测试数据
        for (let i = 0; i < 5; i++) {
          const testScore = {
            score: 80 + Math.floor(Math.random() * 20),
            moves: 8 + Math.floor(Math.random() * 5),
            timeSpent: 0
          };
          window.gameHistoryManager.recordGameScore('mouse', 'default', testScore);
        }

        // 获取历史记录
        const history = window.gameHistoryManager.getGameHistory('mouse', 'default');
        const stats = window.gameHistoryManager.getGameStats('mouse', 'default');

        showResult(`✅ 鼠标轨迹历史记录测试成功`, 'success');
        showResult(`📊 记录数: ${history.length}, 最佳成绩: ${stats.bestScore}`, 'info');

        // 测试历史弹窗
        if (window.historyModal) {
          showResult('✅ 历史弹窗组件可用', 'success');
        } else {
          showResult('⚠️ 历史弹窗组件不可用', 'error');
        }

      } catch (error) {
        showResult(`❌ 鼠标轨迹历史测试失败: ${error.message}`, 'error');
      }
    }

    function testReactionHistory() {
      try {
        if (!window.gameHistoryManager) {
          showResult('❌ 历史管理器未加载', 'error');
          return;
        }

        // 添加一些测试数据
        for (let i = 0; i < 5; i++) {
          const testScore = {
            score: 200 + Math.floor(Math.random() * 300),
            moves: 0,
            timeSpent: 0
          };
          window.gameHistoryManager.recordGameScore('reaction', 'default', testScore);
        }

        // 获取历史记录
        const history = window.gameHistoryManager.getGameHistory('reaction', 'default');
        const stats = window.gameHistoryManager.getGameStats('reaction', 'default');

        showResult(`✅ 反应测试历史记录测试成功`, 'success');
        showResult(`📊 记录数: ${history.length}, 最佳成绩: ${stats.bestScore}毫秒`, 'info');

      } catch (error) {
        showResult(`❌ 反应测试历史测试失败: ${error.message}`, 'error');
      }
    }

    function clearTestData() {
      try {
        if (window.gameHistoryManager) {
          window.gameHistoryManager.clearAllHistory('mouse', 'default');
          window.gameHistoryManager.clearAllHistory('reaction', 'default');
          showResult('✅ 测试数据清理完成', 'success');
        } else {
          showResult('❌ 历史管理器未加载', 'error');
        }
      } catch (error) {
        showResult(`❌ 清理测试数据失败: ${error.message}`, 'error');
      }
    }

    function showStorageInfo() {
      try {
        if (!window.gameHistoryManager) {
          showResult('❌ 历史管理器未加载', 'error');
          return;
        }

        const info = window.gameHistoryManager.getStorageInfo();
        if (info) {
          showResult('📊 存储信息:', 'info');
          showResult(`总游戏数据大小: ${info.totalSize}`, 'info');
          showResult(`历史记录: ${info.gameHistoryCount} 个键, ${info.gameHistorySize}`, 'info');
          showResult(`最佳成绩: ${info.bestScoreCount} 个键, ${info.bestScoreSize}`, 'info');
          showResult(`旧记录: ${info.recordCount} 个键, ${info.recordSize}`, 'info');
          showResult(`localStorage总键数: ${info.totalKeys}`, 'info');
        } else {
          showResult('❌ 获取存储信息失败', 'error');
        }
      } catch (error) {
        showResult(`❌ 获取存储信息失败: ${error.message}`, 'error');
      }
    }

    function resetAllGames() {
      try {
        if (!window.gameHistoryManager) {
          showResult('❌ 历史管理器未加载', 'error');
          return;
        }

        if (confirm('⚠️ 警告：这将删除所有游戏的历史记录、最佳成绩和缓存数据！\n\n此操作不可恢复，确定要继续吗？')) {
          const success = window.gameHistoryManager.resetAllGames();
          if (success) {
            showResult('✅ 所有游戏数据已全局重置', 'success');
            showResult('🔄 页面将在3秒后自动刷新...', 'info');
            setTimeout(() => {
              location.reload();
            }, 3000);
          } else {
            showResult('❌ 全局重置失败', 'error');
          }
        } else {
          showResult('❌ 用户取消了全局重置操作', 'info');
        }
      } catch (error) {
        showResult(`❌ 全局重置失败: ${error.message}`, 'error');
      }
    }

    function testHistoryModal() {
      try {
        if (!window.historyModal) {
          showResult('❌ 历史弹窗组件未加载', 'error');
          return;
        }

        showResult('✅ 历史弹窗组件已加载', 'success');
        
        // 测试显示弹窗
        window.historyModal.show('mouse', 'default');
        showResult('✅ 历史弹窗已显示，请检查按钮是否可见', 'info');
        
        // 检查按钮是否存在
        setTimeout(() => {
          // 检查头部清理按钮
          const headerClearBtn = document.getElementById('header-clear-history');
          if (headerClearBtn) {
            showResult('✅ 找到头部"清理历史"按钮', 'success');
            showResult(`按钮文本: "${headerClearBtn.textContent}"`, 'info');
            showResult(`按钮样式: ${headerClearBtn.className}`, 'info');
          } else {
            showResult('❌ 未找到头部"清理历史"按钮', 'error');
          }
          
          // 检查关闭按钮
          const closeBtn = document.getElementById('history-modal-close');
          if (closeBtn) {
            showResult('✅ 找到关闭按钮', 'success');
          } else {
            showResult('❌ 未找到关闭按钮', 'error');
          }
          
          // 检查表格区域清理按钮
          const clearBtn = document.getElementById('clear-history');
          if (clearBtn) {
            showResult('✅ 找到表格区域"清空记录"按钮', 'success');
            showResult(`按钮文本: "${clearBtn.textContent}"`, 'info');
            showResult(`按钮样式: ${clearBtn.className}`, 'info');
            showResult(`按钮可见性: ${clearBtn.style.display}`, 'info');
            showResult(`按钮位置: ${clearBtn.offsetTop}, ${clearBtn.offsetLeft}`, 'info');
            
            // 检查父元素
            const tableActions = clearBtn.closest('.table-actions');
            if (tableActions) {
              showResult(`✅ 找到父容器 .table-actions`, 'success');
              showResult(`父容器样式: ${tableActions.className}`, 'info');
              showResult(`父容器可见性: ${tableActions.style.display}`, 'info');
            } else {
              showResult('❌ 未找到父容器 .table-actions', 'error');
            }
            
            // 检查弹窗内容
            const modalContent = document.querySelector('.history-modal-content');
            if (modalContent) {
              showResult(`✅ 找到弹窗内容`, 'success');
              showResult(`弹窗内容样式: ${modalContent.className}`, 'info');
            }
            
          } else {
            showResult('❌ 未找到表格区域"清空记录"按钮', 'error');
            
            // 检查所有按钮
            const allButtons = document.querySelectorAll('button');
            showResult(`页面中共有 ${allButtons.length} 个按钮`, 'info');
            allButtons.forEach((btn, index) => {
              if (btn.textContent.includes('清空') || btn.textContent.includes('清理') || btn.textContent.includes('clear')) {
                showResult(`找到相关按钮 ${index}: "${btn.textContent}"`, 'info');
              }
            });
          }
          
          // 检查头部操作区域
          const headerActions = document.querySelector('.header-actions');
          if (headerActions) {
            showResult('✅ 找到头部操作区域', 'success');
            showResult(`头部操作区域样式: ${headerActions.className}`, 'info');
          } else {
            showResult('❌ 未找到头部操作区域', 'error');
          }
          
        }, 500);

      } catch (error) {
        showResult(`❌ 测试历史弹窗失败: ${error.message}`, 'error');
      }
    }

    // 页面加载完成后自动测试历史管理器
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (window.gameHistoryManager) {
          showResult('✅ 页面加载完成，历史管理器已就绪', 'success');
        } else {
          showResult('❌ 页面加载完成，但历史管理器未就绪', 'error');
        }
      }, 1000);
    });
  </script>
</body>
</html>
